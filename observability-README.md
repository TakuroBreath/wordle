# Система мониторинга и логирования Wordle Game

## Обзор

Система наблюдаемости (Observability) для Wordle Game состоит из двух компонентов:

1. **Метрики** - Prometheus + Grafana
2. **Логирование** - Grafana Loki + Promtail + Grafana

Эта комплексная система обеспечивает полную видимость работы приложения, что позволяет:
- Отслеживать производительность и доступность сервисов
- Анализировать ошибки и проблемы в режиме реального времени
- Получать уведомления о критических ситуациях
- Визуализировать поведение системы и бизнес-метрики

## Архитектура системы

```
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│               │          │               │          │               │
│    Grafana    │◀─────────┤   Prometheus  │          │     Loki      │
│               │          │               │          │               │
└───────────────┘          └───────────────┘          └───────────────┘
                                   ▲                          ▲
                                   │                          │
                                   │                          │
                                   │                  ┌───────────────┐
                                   │                  │               │
                                   │                  │   Promtail    │
                                   │                  │               │
                                   │                  └───────────────┘
                                   │                          ▲
                                   │                          │
                                   │                          │
┌──────────────────────────────────────────────────────────────────────┐
│                                                                      │
│                             Приложение                               │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
```

## Компоненты

### Метрики (Prometheus + Grafana)

Prometheus собирает метрики из приложения через HTTP-эндпоинт `/metrics`. Grafana используется для визуализации этих метрик.

#### Собираемые метрики

1. **HTTP-метрики**:
   - `http_request_duration_seconds` - время выполнения запросов
   - `http_requests_total` - количество запросов
   - `errors_total` - количество ошибок

2. **Бизнес-метрики**:
   - `wordle_game_start_total` - количество начатых игр
   - `wordle_game_complete_total` - количество завершенных игр
   - `wordle_game_abandoned_total` - количество брошенных игр
   - `wordle_active_games` - текущее количество активных игр
   - `wordle_word_guessed_total` - статистика угаданных слов по количеству попыток

### Логирование (Loki + Promtail)

Loki используется для централизованного хранения логов, Promtail — для доставки, Grafana — для поиска и визуализации.

#### Компоненты логирования

1. **zap (в приложении)** - пишет человекочитаемые логи в stdout и JSON в файл
2. **Promtail** - читает JSON файл и отправляет в Loki
3. **Loki** - хранит логи
4. **Grafana** - просмотр логов (Explore) и панель на дашборде

#### Структура логов

Логи имеют следующую структуру:

```json
{
  "timestamp": "2023-07-27T12:34:56.789Z",
  "level": "info",
  "message": "Сообщение",
  "logger": "app",
  "caller": "app.go:123",
  "service": "wordle-api",
  "method": "GetGame",
  "game_id": "abc-123-def-456",
  "user_id": 123456
}
```

## Запуск системы

Для запуска полной системы мониторинга и логирования:

```bash
docker-compose -f docker-compose.full.yml up -d
```

## Доступ к компонентам

- **Grafana**: http://localhost:3000 (логин: admin, пароль: secret)
- **Prometheus**: http://localhost:9091
- **Loki**: http://localhost:3100

## Настройка алертов

### Prometheus Alertmanager

Alertmanager настроен на отправку уведомлений при следующих событиях:
- Высокая латентность API (>1s)
- Высокая частота ошибок (>5%)
- Недоступность сервисов

### Логи и алерты

Рекомендуется настраивать алерты через Grafana (по метрикам Prometheus и/или по логам Loki).

## Дашборды

### Grafana

1. **Обзор системы** - общая статистика по сервисам
2. **API-метрики** - детальная информация по API-запросам
3. **Бизнес-метрики** - статистика игр и пользовательской активности
4. **Ресурсы** - мониторинг потребления ресурсов (CPU, память, диск)

### Логи в Grafana

Логи доступны в **Explore** (Data source: Loki) и в дашборде `Wordle Dashboard` (панель **Logs (Loki)**).

## Интеграция компонентов

Система наблюдаемости интегрирована следующим образом:
1. **Метрики** - Grafana отображает метрики из Prometheus
2. **Логи** - Grafana отображает логи из Loki

## Рекомендации по использованию

1. **Мониторинг в реальном времени** - используйте дашборды Grafana для мониторинга системы в реальном времени
2. **Анализ инцидентов** - используйте Grafana Explore (Loki) для анализа логов
3. **Настройка алертов** - настраивайте алерты для раннего обнаружения проблем
4. **Регулярный аудит** - регулярно анализируйте метрики и логи для выявления потенциальных проблем

## Развитие системы

Рекомендации по развитию системы наблюдаемости:
1. Добавить алерты/аннотации в Grafana на основе метрик и логов
2. Интегрировать системы с внешними сервисами мониторинга (Datadog, New Relic)
3. Настроить автоматические действия при алертах (автомасштабирование, автоматическое восстановление) 