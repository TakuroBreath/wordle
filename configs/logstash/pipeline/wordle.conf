input {
  beats {
    port => 5044
  }
  tcp {
    port => 5000
    codec => json
  }
  udp {
    port => 5000
    codec => json
  }
}

filter {
  if [fields][service] == "wordle-api" {
    json {
      source => "message"
      target => "log"
    }

    # Добавляем поле для определения уровня логирования
    if [log][level] == "error" or [log][level] == "ERROR" or [log][level] == "fatal" or [log][level] == "FATAL" {
      mutate {
        add_field => { "severity" => "ERROR" }
      }
    } else if [log][level] == "warn" or [log][level] == "WARN" or [log][level] == "warning" or [log][level] == "WARNING" {
      mutate {
        add_field => { "severity" => "WARNING" }
      }
    } else {
      mutate {
        add_field => { "severity" => "INFO" }
      }
    }

    # Извлекаем полезные метаданные
    if [log][trace_id] {
      mutate {
        add_field => { "trace_id" => "%{[log][trace_id]}" }
      }
    }

    if [log][span_id] {
      mutate {
        add_field => { "span_id" => "%{[log][span_id]}" }
      }
    }

    # Добавляем метки для алертинга
    if [log][level] == "error" or [log][level] == "ERROR" or [log][level] == "fatal" or [log][level] == "FATAL" {
      mutate {
        add_field => { "alert" => "true" }
      }
    }
  }

  # Добавляем временные метки
  date {
    match => [ "[log][timestamp]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ" ]
    target => "@timestamp"
    timezone => "UTC"
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "wordle-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Алерты для критических ошибок
  if [severity] == "ERROR" and [alert] == "true" {
    email {
      address => "smtp.gmail.com"
      port => 587
      username => "${SMTP_USERNAME}"
      password => "${SMTP_PASSWORD}"
      authentication => "plain"
      use_tls => true
      from => "alerts@wordle-game.com"
      subject => "ALERT: Critical error in Wordle application"
      to => "admin@wordle-game.com"
      via => "smtp"
      body => "A critical error has occurred in the Wordle application:\n\nTimestamp: %{@timestamp}\nService: %{[fields][service]}\nMessage: %{[log][message]}\nLevel: %{[log][level]}\nTrace ID: %{[trace_id]}"
    }
  }
} 