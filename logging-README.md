# Система логирования для Wordle Game

## Обзор

Система логирования Wordle Game построена на основе **Grafana Loki** (хранилище логов) + **Promtail** (агент доставки) + **Grafana** (поиск/дашборды). Логи в приложении пишутся через **zap** и разделяются на два потока:

1. **Человекочитаемые** — в stdout (удобно зайти в контейнер и посмотреть)
2. **Структурированные JSON** — в файл (Promtail читает файл и отправляет в Loki)

## Архитектура системы

```
┌─────────────┐         ┌──────────┐         ┌──────────┐
│ Приложение  │──JSON──▶│ Promtail  │──push──▶│   Loki   │
│ (zap)       │         └──────────┘         └──────────┘
│   │         │                                   ▲
│   └ stdout  │                                   │
└─────────────┘                                   │
                                                  │
                                            ┌──────────┐
                                            │ Grafana   │
                                            └──────────┘
```

## Компоненты

1. **Приложение** — пишет логи через `zap` (stdout + JSON файл)
2. **Promtail** — читает JSON файл и отправляет строки в Loki
3. **Loki** — хранит логи и отдаёт их Grafana
4. **Grafana** — просмотр логов (Explore) и панели на дашборде

## Запуск системы

```bash
docker-compose -f docker-compose.logging.yml up -d
```

## Доступ к компонентам

- **Loki**: http://localhost:3100

## Структура логов

Логи имеют следующую структуру:

```json
{
  "timestamp": "2023-07-27T12:34:56.789Z",
  "level": "info",
  "message": "Сообщение",
  "logger": "app",
  "caller": "app.go:123",
  "service": "wordle-api",
  "method": "GetGame",
  "game_id": "abc-123-def-456",
  "user_id": 123456
}
```

## Настройка логирования в приложении

Настройки логирования можно изменить через переменные окружения:

- `LOG_LEVEL` - уровень логирования (debug, info, warn, error, fatal)
- `LOG_FORMAT` - формат логов (json, console)
- `LOG_OUTPUT` - вывод логов (stdout, file)
- `LOG_FILE_PATH` - путь к файлу логов
- `LOG_MAX_SIZE` - максимальный размер файла логов в МБ
- `LOG_MAX_BACKUPS` - максимальное количество файлов бэкапов
- `LOG_MAX_AGE` - максимальное время хранения бэкапов в днях
- `LOG_COMPRESS` - сжатие файлов бэкапов

## Алерты

Система автоматически отправляет уведомления при возникновении критических ошибок. Настройки алертов находятся в конфигурации Logstash.

## Правила использования в коде

```go
// Базовое логирование
logger.Log.Info("Сообщение", zap.String("key", "value"))

// Логирование с контекстом
logger.LogInfo(ctx, "Сообщение", zap.Int("user_id", 123))

// Логирование ошибок
logger.LogError(ctx, "Произошла ошибка", err, zap.String("game_id", "abc-123"))
```

## Мониторинг и отладка

В Grafana можно:

1. Смотреть логи в **Explore** (Data source: Loki)
2. Смотреть логи в дашборде `Wordle Dashboard` (панель **Logs (Loki)**)

## Ротация логов

Ротация логов выполняется автоматически на основе следующих параметров:
- Максимальный размер файла: 100 МБ
- Максимальное количество файлов: 30
- Максимальное время хранения: 30 дней
- Сжатие файлов: включено 